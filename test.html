<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sản Phẩm Bán Kèm</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/@alpinejs/persist@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .product { border: 1px solid #ccc; padding: 15px; margin: 10px; border-radius: 8px; }
        .button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .add-cart { background: #e91e63; color: white; }
        .buy-now { background: #2196f3; color: white; }
        .cart { background: #f5f5f5; padding: 15px; margin-top: 20px; border-radius: 8px; }
    </style>
</head>
<body>
    <div x-data="testApp()">
        <h1>Test Sản Phẩm Bán Kèm</h1>
        
        <div class="product">
            <h3>Sản phẩm thông thường</h3>
            <p>Vòng trơn buộc mối</p>
            <button class="button add-cart" 
                    @click="isAddonProduct(normalProduct) ? addAddonToCart(normalProduct) : openItemOptionsModal(normalProduct)">
                Thêm vào giỏ hàng
            </button>
            <button class="button buy-now" 
                    @click="isAddonProduct(normalProduct) ? addAddonToCart(normalProduct) : buyNow(normalProduct)">
                <span x-text="isAddonProduct(normalProduct) ? 'Thêm vào giỏ' : 'Mua ngay'"></span>
            </button>
        </div>

        <div class="product">
            <h3>Sản phẩm bán kèm</h3>
            <p>Túi Đựng Vòng Dâu Tằm Nhung</p>
            <button class="button add-cart"
                    @click="isAddonProduct(addonProduct) ? addAddonToCart(addonProduct) : openItemOptionsModal(addonProduct)">
                Thêm vào giỏ hàng
            </button>
            <button class="button buy-now"
                    @click="isAddonProduct(addonProduct) ? addAddonToCart(addonProduct) : buyNow(addonProduct)">
                <span x-text="isAddonProduct(addonProduct) ? 'Thêm vào giỏ' : 'Mua ngay'"></span>
            </button>
        </div>

        <div class="product">
            <h3>Bi, charm bạc</h3>
            <p>Bi bạc ta 3ly trơn</p>
            <button class="button add-cart"
                    @click="isAddonProduct(biCharmBacProduct) ? addAddonToCart(biCharmBacProduct) : openItemOptionsModal(biCharmBacProduct)">
                Thêm vào giỏ hàng
            </button>
            <button class="button buy-now"
                    @click="isAddonProduct(biCharmBacProduct) ? addAddonToCart(biCharmBacProduct) : buyNow(biCharmBacProduct)">
                <span x-text="isAddonProduct(biCharmBacProduct) ? 'Thêm vào giỏ' : 'Mua ngay'"></span>
            </button>
        </div>

        <div class="cart">
            <h3>Giỏ hàng</h3>
            <div x-show="cart.length === 0">Giỏ hàng trống</div>
            <template x-for="item in cart" :key="item.id">
                <div>
                    <span x-text="item.name"></span> -
                    <span x-text="item.quantity"></span> -
                    <span x-text="formatCurrency(item.price * item.quantity)"></span> -
                    <span x-text="isAddonProduct(item) ? 'Sản phẩm bán kèm' : 'Sản phẩm thông thường'"></span>
                </div>
            </template>
        </div>

        <div class="cart">
            <h3>Test Addon Products từ JavaScript</h3>
            <div>
                <h4>Bó dâu tằm 7 cành (addon) - FREESHIP</h4>
                <button class="button add-cart" @click="addAddonToCart(testAddon7Canh)">Thêm 7 cành</button>
            </div>
            <div>
                <h4>Bó dâu tằm 9 cành (addon) - FREESHIP</h4>
                <button class="button add-cart" @click="addAddonToCart(testAddon9Canh)">Thêm 9 cành</button>
            </div>
            <div>
                <h4>Test Freeship Logic</h4>
                <p>Có freeship: <span x-text="testFreeShipping() ? 'CÓ' : 'KHÔNG'"></span></p>
                <p>Phí ship: <span x-text="formatCurrency(testShippingFee())"></span></p>
            </div>
        </div>

        <div class="cart">
            <h3>Test Smart Filtering</h3>
            <div>
                <h4>Danh sách addon hiển thị (sẽ ẩn những cái đã thêm vào giỏ):</h4>
                <div x-show="testFilteredAddons().length === 0">Tất cả addon đã được thêm vào giỏ hàng!</div>
                <template x-for="addon in testFilteredAddons()" :key="addon.id">
                    <div style="border: 1px solid #ccc; padding: 5px; margin: 5px;">
                        <span x-text="addon.name"></span> -
                        <span x-text="formatCurrency(addon.price)"></span>
                        <button class="button add-cart" @click="addAddonToCart(addon)">Thêm</button>
                    </div>
                </template>
            </div>
        </div>

        <div class="cart">
            <h3>Test Bead Products (Hạt dâu tằm mài sẵn)</h3>
            <div>
                <h4>Hạt dâu tằm loại đẹp + chỉ đỏ</h4>
                <button class="button add-cart" @click="openBeadQuantityModal(testBeadProduct)">Chọn số lượng hạt</button>
            </div>
        </div>

        <div x-show="isItemOptionsModalOpen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px;">
                <h3>Chọn cân nặng</h3>
                <p x-text="currentItemForOptions?.name"></p>
                <button @click="closeItemOptionsModal()" class="button">Đóng</button>
            </div>
        </div>

        <div x-show="alert.show" x-text="alert.message" 
             style="position: fixed; top: 20px; right: 20px; background: green; color: white; padding: 10px; border-radius: 4px;"></div>
    </div>

    <script>
        function testApp() {
            return {
                cart: [],
                isItemOptionsModalOpen: false,
                currentItemForOptions: null,
                alert: { show: false, message: '' },
                
                normalProduct: {
                    id: "vong_tron_002",
                    name: "Vòng trơn buộc mối",
                    category: "vong_tron",
                    price: 79000
                },
                
                addonProduct: {
                    id: "san_pham_ban_kem_001",
                    name: "Túi Đựng Vòng Dâu Tằm Nhung",
                    category: "san_pham_ban_kem",
                    price: 59000
                },

                biCharmBacProduct: {
                    id: "bi_charm_bac_001",
                    name: "Bi bạc ta 3ly trơn",
                    category: "bi_charm_bac",
                    price: 89000
                },

                testAddon7Canh: {
                    id: 'addon_bo_dau_tam_7_canh',
                    name: 'Bó dâu tằm 7 CÀNH cho bé trai',
                    price: 89000
                },

                testAddon9Canh: {
                    id: 'addon_bo_dau_tam_9_canh',
                    name: 'Bó dâu tằm 9 CÀNH cho bé gái',
                    price: 99000
                },

                testBeadProduct: {
                    id: 'hat_dau_tam_mai_san_002',
                    name: 'Hạt dâu tằm loại đẹp + chỉ đỏ',
                    category: 'hat_dau_tam_mai_san',
                    price: 99000,
                    image: './assets/images/product_img/hat_dau_tam.jpg'
                },

                // Kiểm tra xem sản phẩm có phải là sản phẩm bán kèm không
                isAddonProduct(product) {
                    if (!product) return false;
                    return product.category === 'san_pham_ban_kem' ||
                           product.category === 'bi_charm_bac' ||
                           (product.categories && product.categories.includes('san_pham_ban_kem')) ||
                           (product.categories && product.categories.includes('bi_charm_bac'));
                },

                // Kiểm tra xem sản phẩm có phải là hạt dâu tằm mài sẵn không
                isBeadProduct(product) {
                    if (!product) return false;
                    return product.category === 'hat_dau_tam_mai_san' ||
                           (product.categories && product.categories.includes('hat_dau_tam_mai_san'));
                },

                openBeadQuantityModal(product) {
                    this.showAlert('Mở modal chọn số lượng hạt cho: ' + product.name);
                    // Giả lập thêm sản phẩm với 17 hạt
                    const beadItem = {
                        ...product,
                        cartId: `${product.id}-${Date.now()}`,
                        quantity: 1,
                        beadQuantity: 17, // Test với 17 hạt
                        notes: 'Test bead product'
                    };
                    this.cart.push(beadItem);
                    this.showAlert('Đã thêm ' + product.name + ' (17 hạt) vào giỏ hàng!');
                },

                // Test functions for bead quantity
                increaseBeadQuantity(cartId) {
                    const item = this.cart.find(i => i.cartId === cartId);
                    if (item && item.beadQuantity && item.beadQuantity < 50) {
                        item.beadQuantity++;
                        this.showAlert(`Tăng lên ${item.beadQuantity} hạt`);
                    }
                },

                decreaseBeadQuantity(cartId) {
                    const item = this.cart.find(i => i.cartId === cartId);
                    if (item && item.beadQuantity && item.beadQuantity > 14) {
                        item.beadQuantity--;
                        this.showAlert(`Giảm xuống ${item.beadQuantity} hạt`);
                    } else if (item && item.beadQuantity && item.beadQuantity <= 14) {
                        if (confirm('Số lượng hạt tối thiểu là 14. Bạn có muốn xóa sản phẩm này khỏi giỏ hàng?')) {
                            this.cart = this.cart.filter(i => i.cartId !== cartId);
                            this.showAlert('Đã xóa sản phẩm khỏi giỏ hàng');
                        }
                    }
                },

                openItemOptionsModal(product) {
                    this.currentItemForOptions = product;
                    this.isItemOptionsModalOpen = true;
                    this.showAlert('Mở modal chọn cân nặng cho: ' + product.name);
                },

                closeItemOptionsModal() {
                    this.isItemOptionsModalOpen = false;
                    this.currentItemForOptions = null;
                },

                addAddonToCart(addon) {
                    const existing = this.cart.find(i => i.id === addon.id);
                    if (existing) {
                        existing.quantity++;
                    } else {
                        this.cart.push({ ...addon, quantity: 1 });
                    }
                    this.showAlert('Đã thêm ' + addon.name + ' vào giỏ hàng!');
                },

                buyNow(product) {
                    this.showAlert('Mở modal mua ngay cho: ' + product.name);
                },

                showAlert(message) {
                    this.alert = { show: true, message };
                    setTimeout(() => {
                        this.alert.show = false;
                    }, 3000);
                },

                formatCurrency(amount) {
                    return new Intl.NumberFormat('vi-VN', {
                        style: 'currency',
                        currency: 'VND'
                    }).format(amount);
                },

                // Test freeship logic
                testFreeShipping() {
                    // Giả lập logic freeship
                    const hasFreeshippingAddon = this.cart.some(item =>
                        item.id === 'addon_tui_dau_tam' ||
                        item.id === 'addon_bo_dau_tam_7_canh' ||
                        item.id === 'addon_bo_dau_tam_9_canh'
                    );
                    const hasMainProduct = this.cart.some(item =>
                        item.id !== 'addon_tui_dau_tam' &&
                        item.id !== 'addon_bo_dau_tam_7_canh' &&
                        item.id !== 'addon_bo_dau_tam_9_canh' &&
                        item.id !== 'addon_moc_chia_khoa'
                    );
                    return hasFreeshippingAddon && hasMainProduct;
                },

                testShippingFee() {
                    return this.testFreeShipping() ? 0 : 21000;
                },

                // Test smart filtering
                testFilteredAddons() {
                    const allAddons = [
                        this.testAddon7Canh,
                        this.testAddon9Canh,
                        {
                            id: 'addon_tui_dau_tam',
                            name: 'Túi Dâu Tằm Để Phòng',
                            price: 39000
                        },
                        {
                            id: 'addon_moc_chia_khoa',
                            name: 'Móc Chìa Khóa Dâu Tằm',
                            price: 29000
                        }
                    ];

                    // Lọc ra những addon chưa có trong giỏ hàng
                    return allAddons.filter(addon => !this.cart.some(item => item.id === addon.id));
                }
            }
        }
    </script>
</body>
</html>
