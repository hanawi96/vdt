<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Production - Debug</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 { 
            color: #667eea; 
            margin-top: 0;
            font-size: 28px;
        }
        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #667eea;
        }
        .info-box code {
            background: #e0e7ff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        button { 
            padding: 12px 24px; 
            margin: 8px 4px; 
            cursor: pointer; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .output { 
            background: #1e1e1e; 
            color: #d4d4d4;
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0; 
            white-space: pre-wrap; 
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { color: #4ec9b0; font-weight: bold; }
        .error { color: #f48771; font-weight: bold; }
        .warning { color: #dcdcaa; }
        .info { color: #569cd6; }
        .highlight { 
            background: #264f78; 
            padding: 2px 4px; 
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Production Environment</h1>
        
        <div class="info-box">
            <h3>üìç Th√¥ng tin m√¥i tr∆∞·ªùng hi·ªán t·∫°i:</h3>
            <p><strong>Hostname:</strong> <code id="hostname"></code></p>
            <p><strong>URL:</strong> <code id="fullUrl"></code></p>
            <p><strong>Worker URL:</strong> <code>https://ctv-api.yendev96.workers.dev</code></p>
        </div>

        <div style="margin: 20px 0;">
            <button onclick="testEnvironment()">üß™ Test Environment</button>
            <button onclick="testWorkerConnection()">üîå Test Worker Connection</button>
            <button onclick="testCreateOrder()">üì¶ Test Create Order</button>
            <button onclick="clearOutput()">üóëÔ∏è Clear</button>
        </div>

        <div id="output" class="output">Nh·∫•n n√∫t ƒë·ªÉ b·∫Øt ƒë·∫ßu test...</div>
    </div>

    <script>
        const output = document.getElementById('output');
        
        // Hi·ªÉn th·ªã th√¥ng tin m√¥i tr∆∞·ªùng
        document.getElementById('hostname').textContent = window.location.hostname;
        document.getElementById('fullUrl').textContent = window.location.href;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('vi-VN');
            const className = type;
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            output.innerHTML = '';
        }

        function testEnvironment() {
            log('=== TEST ENVIRONMENT ===', 'info');
            log(`üåê Hostname: ${window.location.hostname}`, 'info');
            log(`üìç Protocol: ${window.location.protocol}`, 'info');
            log(`üîó Full URL: ${window.location.href}`, 'info');
            log(`üéØ Origin: ${window.location.origin}`, 'info');
            
            // Ki·ªÉm tra xem ƒëang ·ªü ƒë√¢u
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                log('‚úÖ ƒêang ch·∫°y ·ªü LOCAL', 'success');
            } else if (window.location.hostname.includes('.pages.dev')) {
                log('‚úÖ ƒêang ch·∫°y tr√™n CLOUDFLARE PAGES', 'success');
            } else {
                log('‚úÖ ƒêang ch·∫°y tr√™n CUSTOM DOMAIN', 'success');
            }
            
            // Ki·ªÉm tra API URL s·∫Ω ƒë∆∞·ª£c g·ªçi
            const apiUrl = `https://ctv-api.yendev96.workers.dev/api/order/create`;
            log(`\nüéØ API URL s·∫Ω g·ªçi: <span class="highlight">${apiUrl}</span>`, 'info');
        }

        async function testWorkerConnection() {
            log('\n=== TEST WORKER CONNECTION ===', 'info');
            const workerUrl = 'https://ctv-api.yendev96.workers.dev';
            
            try {
                log(`üì° ƒêang k·∫øt n·ªëi ƒë·∫øn: ${workerUrl}`, 'info');
                
                const response = await fetch(workerUrl, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                log(`‚úÖ Worker ph·∫£n h·ªìi! Status: ${response.status}`, 'success');
                
                const text = await response.text();
                log(`üì• Response: ${text.substring(0, 100)}...`, 'info');
                
                // Test CORS
                log(`\nüîí Ki·ªÉm tra CORS:`, 'info');
                const corsHeaders = response.headers.get('Access-Control-Allow-Origin');
                if (corsHeaders) {
                    log(`‚úÖ CORS OK: ${corsHeaders}`, 'success');
                } else {
                    log(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y CORS headers`, 'warning');
                }
                
            } catch (error) {
                log(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
                log(`‚ö†Ô∏è C√≥ th·ªÉ b·ªã ch·∫∑n b·ªüi CORS ho·∫∑c Worker kh√¥ng ho·∫°t ƒë·ªông`, 'warning');
            }
        }

        async function testCreateOrder() {
            log('\n=== TEST CREATE ORDER ===', 'info');
            
            const orderId = `TEST${Date.now()}`;
            const orderData = {
                orderId: orderId,
                orderDate: new Date().toISOString(),
                customer: {
                    name: 'Test Customer',
                    phone: '0123456789',
                    email: 'test@example.com',
                    address: '123 Test Street',
                    notes: 'Test from production'
                },
                cart: [
                    {
                        name: 'Test Product',
                        price: '100.000ƒë',
                        quantity: 1,
                        weight: 10,
                        notes: ''
                    }
                ],
                subtotal: '100.000ƒë',
                shipping: 'Mi·ªÖn ph√≠',
                discount: 'Kh√¥ng c√≥',
                total: '100.000ƒë',
                totalAmount: 100000,
                paymentMethod: 'COD',
                referralCode: 'CTV009726',
                referralPartner: 'Test Partner',
                referralCommission: 0,
                telegramNotification: 'VDT_SECRET_2025_ANHIEN'
            };
            
            log(`üì§ G·ª≠i ƒë∆°n h√†ng: ${orderId}`, 'info');
            log(`üìã Referral Code: <span class="highlight">CTV009726</span>`, 'info');
            log(`üí∞ Total: 100.000ƒë`, 'info');
            
            try {
                const apiUrl = 'https://ctv-api.yendev96.workers.dev/api/order/create';
                log(`\nüéØ G·ªçi API: ${apiUrl}`, 'info');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                log(`üì• Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                const result = await response.json();
                log(`üì• Response Data:`, 'info');
                log(JSON.stringify(result, null, 2), 'info');
                
                if (result.success) {
                    log(`\n‚úÖ TH√ÄNH C√îNG!`, 'success');
                    log(`üìù Order ID: ${result.orderId}`, 'success');
                    log(`üíµ Commission: ${result.commission}`, result.commission > 0 ? 'success' : 'warning');
                    
                    if (result.commission === 0) {
                        log(`‚ö†Ô∏è Commission = 0 ‚Üí CTV c√≥ th·ªÉ kh√¥ng t·ªìn t·∫°i trong D1`, 'warning');
                    }
                } else {
                    log(`\n‚ùå L·ªñI: ${result.error || result.message}`, 'error');
                }
                
            } catch (error) {
                log(`\n‚ùå L·ªói g·ªçi API: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }

        // Auto run on load
        window.onload = () => {
            log('üöÄ Production Test Tool ƒë√£ s·∫µn s√†ng!', 'success');
            testEnvironment();
        };
    </script>
</body>
</html>
