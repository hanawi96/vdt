<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Order API</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .container { max-width: 1200px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007acc; color: white; border: none; border-radius: 4px; }
        button:hover { background: #005a9e; }
        .output { background: #252526; padding: 15px; border-radius: 4px; margin: 10px 0; white-space: pre-wrap; word-wrap: break-word; }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        .info { color: #569cd6; }
        input, select { padding: 8px; margin: 5px; background: #3c3c3c; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; }
        label { display: inline-block; width: 150px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Order API - Debug Tool</h1>
        
        <div style="margin: 20px 0;">
            <h3>C·∫•u h√¨nh Test:</h3>
            <div>
                <label>Worker URL:</label>
                <input type="text" id="workerUrl" value="https://ctv-api.yendev96.workers.dev" style="width: 400px;">
            </div>
            <div>
                <label>Referral Code:</label>
                <input type="text" id="referralCode" value="CTV843817" placeholder="Nh·∫≠p m√£ CTV">
            </div>
            <div>
                <label>Customer Name:</label>
                <input type="text" id="customerName" value="Nguy·ªÖn Test" placeholder="T√™n kh√°ch h√†ng">
            </div>
            <div>
                <label>Customer Phone:</label>
                <input type="text" id="customerPhone" value="0123456789" placeholder="SƒêT">
            </div>
            <div>
                <label>Total Amount:</label>
                <input type="number" id="totalAmount" value="150000" placeholder="T·ªïng ti·ªÅn">
            </div>
        </div>

        <div style="margin: 20px 0;">
            <button onclick="testWorkerHealth()">1Ô∏è‚É£ Test Worker Health</button>
            <button onclick="testCreateOrder()">2Ô∏è‚É£ Test Create Order</button>
            <button onclick="testCheckD1()">3Ô∏è‚É£ Check D1 Orders</button>
            <button onclick="testCheckCTV()">4Ô∏è‚É£ Check CTV Info</button>
            <button onclick="clearOutput()">üóëÔ∏è Clear Output</button>
        </div>

        <div id="output" class="output">Nh·∫•n n√∫t ƒë·ªÉ b·∫Øt ƒë·∫ßu test...</div>
    </div>

    <script>
        const output = document.getElementById('output');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('vi-VN');
            const className = type;
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            output.innerHTML = '';
        }

        async function testWorkerHealth() {
            log('=== TEST 1: Worker Health Check ===', 'info');
            const workerUrl = document.getElementById('workerUrl').value;
            
            try {
                log(`ƒêang ping: ${workerUrl}`, 'info');
                const response = await fetch(workerUrl, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                log(`‚úÖ Worker ƒëang ho·∫°t ƒë·ªông! Status: ${response.status}`, 'success');
                
                const text = await response.text();
                log(`Response: ${text.substring(0, 200)}...`, 'info');
                
            } catch (error) {
                log(`‚ùå L·ªói k·∫øt n·ªëi Worker: ${error.message}`, 'error');
                log(`‚ö†Ô∏è Ki·ªÉm tra: Worker c√≥ ƒëang ch·∫°y kh√¥ng?`, 'warning');
            }
        }

        async function testCreateOrder() {
            log('\n=== TEST 2: Create Order ===', 'info');
            const workerUrl = document.getElementById('workerUrl').value;
            const referralCode = document.getElementById('referralCode').value;
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const totalAmount = parseInt(document.getElementById('totalAmount').value);
            
            const orderId = `TEST${Date.now()}`;
            
            const orderData = {
                orderId: orderId,
                orderDate: new Date().toISOString(),
                customer: {
                    name: customerName,
                    phone: customerPhone,
                    email: 'test@example.com',
                    address: '123 Test Street, Test City',
                    notes: 'Test order from debug tool'
                },
                cart: [
                    {
                        name: 'S·∫£n ph·∫©m Test',
                        price: '150.000ƒë',
                        quantity: 1,
                        weight: 10,
                        notes: ''
                    }
                ],
                subtotal: '150.000ƒë',
                shipping: 'Mi·ªÖn ph√≠',
                discount: 'Kh√¥ng c√≥',
                total: `${totalAmount.toLocaleString('vi-VN')}ƒë`,
                totalAmount: totalAmount,
                paymentMethod: 'Thanh to√°n khi nh·∫≠n h√†ng (COD)',
                referralCode: referralCode,
                referralPartner: 'Test Partner',
                referralCommission: 0,
                telegramNotification: 'VDT_SECRET_2025_ANHIEN'
            };
            
            log(`üì§ G·ª≠i ƒë∆°n h√†ng: ${orderId}`, 'info');
            log(`üìã Referral Code: ${referralCode}`, 'info');
            log(`üí∞ Total Amount: ${totalAmount}`, 'info');
            log(`üì¶ Data: ${JSON.stringify(orderData, null, 2)}`, 'info');
            
            try {
                const response = await fetch(`${workerUrl}/api/order/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                log(`üì• Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                const result = await response.json();
                log(`üì• Response Data: ${JSON.stringify(result, null, 2)}`, response.ok ? 'success' : 'error');
                
                if (result.success) {
                    log(`‚úÖ ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!`, 'success');
                    log(`üìù Order ID: ${result.orderId || orderId}`, 'success');
                    log(`üíµ Commission: ${result.commission || 0}`, 'success');
                } else {
                    log(`‚ùå L·ªói: ${result.error || result.message}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå L·ªói g·ªçi API: ${error.message}`, 'error');
                log(`‚ö†Ô∏è Stack: ${error.stack}`, 'warning');
            }
        }

        async function testCheckD1() {
            log('\n=== TEST 3: Check D1 Orders ===', 'info');
            const workerUrl = document.getElementById('workerUrl').value;
            
            try {
                log(`üìä L·∫•y danh s√°ch ƒë∆°n h√†ng m·ªõi nh·∫•t...`, 'info');
                const response = await fetch(`${workerUrl}?action=getRecentOrders&limit=5`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ T√¨m th·∫•y ${result.orders.length} ƒë∆°n h√†ng`, 'success');
                    result.orders.forEach((order, index) => {
                        log(`\nüì¶ ƒê∆°n h√†ng ${index + 1}:`, 'info');
                        log(`  - Order ID: ${order.order_id}`, 'info');
                        log(`  - Customer: ${order.customer_name}`, 'info');
                        log(`  - Total: ${order.total_amount}`, 'info');
                        log(`  - Referral: ${order.referral_code || 'Kh√¥ng c√≥'}`, order.referral_code ? 'success' : 'warning');
                        log(`  - Commission: ${order.commission || 0}`, 'info');
                        log(`  - Created: ${order.created_at}`, 'info');
                    });
                } else {
                    log(`‚ùå L·ªói: ${result.error}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        async function testCheckCTV() {
            log('\n=== TEST 4: Check CTV Info ===', 'info');
            const workerUrl = document.getElementById('workerUrl').value;
            const referralCode = document.getElementById('referralCode').value;
            
            try {
                log(`üîç Ki·ªÉm tra CTV: ${referralCode}`, 'info');
                const response = await fetch(`${workerUrl}?action=getOrders&referralCode=${referralCode}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ T√¨m th·∫•y CTV: ${result.ctvInfo?.name || 'N/A'}`, 'success');
                    log(`üìû Phone: ${result.ctvInfo?.phone || 'N/A'}`, 'info');
                    log(`üìç Address: ${result.ctvInfo?.address || 'N/A'}`, 'info');
                    log(`üì¶ S·ªë ƒë∆°n h√†ng: ${result.orders?.length || 0}`, 'info');
                    
                    if (result.orders && result.orders.length > 0) {
                        log(`\nüìã Danh s√°ch ƒë∆°n h√†ng:`, 'info');
                        result.orders.forEach((order, index) => {
                            log(`  ${index + 1}. ${order.order_id} - ${order.total_amount}ƒë - ${order.created_at}`, 'info');
                        });
                    }
                } else {
                    log(`‚ùå L·ªói: ${result.error}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        // Auto test on load
        window.onload = () => {
            log('üöÄ Debug Tool ƒë√£ s·∫µn s√†ng!', 'success');
            log('üí° H∆∞·ªõng d·∫´n:', 'info');
            log('  1. Test Worker Health - Ki·ªÉm tra Worker c√≥ ho·∫°t ƒë·ªông kh√¥ng', 'info');
            log('  2. Test Create Order - T·∫°o ƒë∆°n h√†ng th·ª≠ nghi·ªám', 'info');
            log('  3. Check D1 Orders - Xem ƒë∆°n h√†ng trong D1', 'info');
            log('  4. Check CTV Info - Ki·ªÉm tra th√¥ng tin CTV', 'info');
            log('\n‚ö†Ô∏è L∆∞u √Ω: ƒê·∫£m b·∫£o Worker URL ƒë√∫ng!', 'warning');
        };
    </script>
</body>
</html>
